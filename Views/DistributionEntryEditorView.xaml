<UserControl x:Class="Boutique.Views.DistributionEntryEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Boutique.ViewModels"
             xmlns:models="clr-namespace:Boutique.Models"
             xmlns:controls="clr-namespace:Boutique.Controls"
             xmlns:themes="clr-namespace:Boutique.Themes"
             xmlns:util="clr-namespace:Boutique.Utilities"
             xmlns:lex="http://wpflocalizeextension.codeplex.com"
             xmlns:res="clr-namespace:Boutique.Resources"
             mc:Ignorable="d"
             x:Name="Root"
             d:DataContext="{d:DesignInstance vm:DistributionEditTabViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="400"
             d:DesignWidth="500">
  <GroupBox Header="Entry Details" Padding="6">
    <TabControl>
      <TabItem>
        <TabItem.Header>
          <TextBlock Text="Filters" />
        </TabItem.Header>
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
          <StackPanel DataContext="{Binding SelectedEntry}">
            <StackPanel.Style>
              <Style TargetType="StackPanel">
                <Setter Property="IsEnabled" Value="True" />
                <Style.Triggers>
                  <DataTrigger Binding="{Binding}" Value="{x:Null}">
                    <Setter Property="IsEnabled" Value="False" />
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </StackPanel.Style>

        <!-- No entry selected message -->
        <TextBlock Text="Select an entry from the list to edit its details"
                   Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}"
                   HorizontalAlignment="Center" Margin="0,20"
                   Visibility="{Binding DataContext.SelectedEntry, ElementName=Root, Converter={StaticResource NullToVisConverter}, ConverterParameter=Inverse}" />

        <!-- Entry editor content -->
        <StackPanel
          Visibility="{Binding DataContext.SelectedEntry, ElementName=Root, Converter={StaticResource NullToVisConverter}}">

          <!-- Type → Target | Chance -->
          <Grid Margin="0,0,0,8">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Type dropdown -->
            <ComboBox Grid.Column="0" ItemsSource="{x:Static vm:DistributionEntryViewModel.TypeOptions}"
                      SelectedItem="{Binding Type, Mode=TwoWay}"
                      MinWidth="90" Height="26" VerticalContentAlignment="Center" Margin="0,0,8,0" />

            <!-- Arrow -->
            <TextBlock Grid.Column="1" Text="→" VerticalAlignment="Center" FontSize="16" Margin="0,0,8,0" />

            <!-- Target selector (Outfit/Keyword/ExclusiveGroup) -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
              <!-- Outfit selector -->
              <StackPanel Orientation="Horizontal"
                          Visibility="{Binding IsOutfitDistribution, Converter={StaticResource BoolToVisConverter}}">
                <controls:FilterableSelector
                  ItemsSource="{Binding DataContext.AvailableOutfits, ElementName=Root}"
                  SelectedItem="{Binding SelectedOutfit, Mode=TwoWay}"
                  DisplayMemberPath="EditorID"
                  FilterPath="EditorID"
                  MinWidth="200"
                  MaxDropDownHeight="300"
                  DropDownOpened="FilterableSelector_DropDownOpened" />
                <Button ToolTip="{lex:Loc Key={x:Static res:LocalizationKeys+OutfitCreator.PreviewOutfit}}"
                        Style="{DynamicResource {x:Static themes:ResourceKeys.IconButtonStyleKey}}"
                        Command="{Binding DataContext.PreviewEntryCommand, ElementName=Root}"
                        CommandParameter="{Binding}"
                        Margin="6,0,0,0">
                  <Image Source="pack://application:,,,/Assets/eye.png" Width="14" Height="14" />
                </Button>
              </StackPanel>

              <!-- Keyword selector -->
              <ComboBox Visibility="{Binding IsKeywordDistribution, Converter={StaticResource BoolToVisConverter}}"
                        ItemsSource="{Binding DataContext.AvailableKeywords, ElementName=Root}"
                        Text="{Binding KeywordToDistribute, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        DisplayMemberPath="EditorID"
                        IsEditable="True"
                        MinWidth="200" Height="26" VerticalContentAlignment="Center"
                        ToolTip="{lex:Loc Key={x:Static res:LocalizationKeys+Distribution.SelectKeywordTooltip}}" />

              <!-- Exclusive group selector -->
              <StackPanel Orientation="Horizontal"
                          Visibility="{Binding IsExclusiveGroupDistribution, Converter={StaticResource BoolToVisConverter}}">
                <TextBox Text="{Binding ExclusiveGroupName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         MinWidth="140" Height="26" VerticalContentAlignment="Center" Margin="0,0,8,0"
                         ToolTip="ExclusiveGroup name." />
                <TextBlock Text="Forms:" VerticalAlignment="Center" Margin="0,0,6,0" />
                <TextBox Text="{Binding ExclusiveGroupFormsText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         MinWidth="180" Height="26" VerticalContentAlignment="Center"
                         ToolTip="Comma-separated forms list." />
              </StackPanel>
            </StackPanel>

            <!-- Chance -->
            <StackPanel Grid.Column="3" Orientation="Horizontal" Margin="12,0,0,0">
              <TextBlock Text="Chance:" VerticalAlignment="Center" Margin="0,0,6,0" />
              <CheckBox Content="☑" IsChecked="{Binding UseChance, Mode=TwoWay}" VerticalAlignment="Center"
                        Margin="0,0,4,0" ToolTip="{lex:Loc Key={x:Static res:LocalizationKeys+Distribution.UseChance}}" />
              <TextBox Text="{Binding Chance, UpdateSourceTrigger=PropertyChanged}" Width="40" Height="26"
                       IsEnabled="{Binding UseChance}" VerticalContentAlignment="Center" Padding="4,0" />
              <TextBlock Text="%" VerticalAlignment="Center" Margin="2,0,0,0" />
            </StackPanel>
          </Grid>

          <!-- Traits Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8">
            <StackPanel>
              <TextBlock Text="Traits" FontWeight="SemiBold" FontSize="11" Margin="0,0,0,6" />
              <WrapPanel>
                <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                  <TextBlock Text="Gender:" VerticalAlignment="Center" Margin="0,0,6,0" FontSize="11" />
                  <ComboBox ItemsSource="{x:Static vm:DistributionEntryViewModel.GenderOptions}"
                            SelectedItem="{Binding Gender, Mode=TwoWay}"
                            MinWidth="80" Height="24" VerticalContentAlignment="Center" FontSize="11" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                  <TextBlock Text="Unique:" VerticalAlignment="Center" Margin="0,0,6,0" FontSize="11" />
                  <ComboBox ItemsSource="{x:Static vm:DistributionEntryViewModel.UniqueOptions}"
                            SelectedItem="{Binding Unique, Mode=TwoWay}"
                            MinWidth="100" Height="24" VerticalContentAlignment="Center" FontSize="11" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="Level:" VerticalAlignment="Center" Margin="0,0,6,0" FontSize="11" />
                  <ComboBox SelectedValue="{Binding LevelFilterMode, Mode=TwoWay}"
                            SelectedValuePath="Tag"
                            Width="110" Height="24" VerticalContentAlignment="Center"
                            Margin="0,0,6,0" FontSize="11"
                            ToolTip="{lex:Loc Key={x:Static res:LocalizationKeys+Distribution.LevelSkillTooltip}}">
                    <ComboBoxItem Tag="{x:Static vm:LevelFilterMode.None}" Content="None" />
                    <ComboBoxItem Tag="{x:Static vm:LevelFilterMode.Level}" Content="Level" />
                    <ComboBoxItem Tag="{x:Static vm:LevelFilterMode.SkillLevel}" Content="Skill Level" />
                    <ComboBoxItem Tag="{x:Static vm:LevelFilterMode.SkillWeight}" Content="Skill Weight" />
                    <ComboBoxItem Tag="{x:Static vm:LevelFilterMode.Raw}" Content="Raw" />
                  </ComboBox>
                  <ComboBox ItemsSource="{x:Static vm:DistributionEntryViewModel.SkillFilterOptions}"
                            SelectedItem="{Binding SelectedLevelSkill, Mode=TwoWay}"
                            DisplayMemberPath="DisplayText"
                            Width="120" Height="24" VerticalContentAlignment="Center"
                            Margin="0,0,6,0" FontSize="11"
                            Visibility="{Binding IsSkillLevelMode, Converter={StaticResource BoolToVisConverter}}" />
                  <TextBlock Text="Min"
                             VerticalAlignment="Center" FontSize="11"
                             Margin="0,0,4,0"
                             Visibility="{Binding HasRangeLevelFilterMode, Converter={StaticResource BoolToVisConverter}}" />
                  <TextBox Text="{Binding LevelFilterMin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                           Width="40" Height="24" VerticalContentAlignment="Center" FontSize="11"
                           Margin="0,0,6,0"
                           Visibility="{Binding HasRangeLevelFilterMode, Converter={StaticResource BoolToVisConverter}}" />
                  <TextBlock Text="Max"
                             VerticalAlignment="Center" FontSize="11"
                             Margin="0,0,4,0"
                             Visibility="{Binding HasRangeLevelFilterMode, Converter={StaticResource BoolToVisConverter}}" />
                  <TextBox Text="{Binding LevelFilterMax, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                           Width="40" Height="24" VerticalContentAlignment="Center" FontSize="11"
                           Visibility="{Binding HasRangeLevelFilterMode, Converter={StaticResource BoolToVisConverter}}" />
                  <TextBox Text="{Binding LevelFilters, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                           Width="150" Height="24" VerticalContentAlignment="Center" FontSize="11"
                           Visibility="{Binding IsRawLevelFilterMode, Converter={StaticResource BoolToVisConverter}}"
                           ToolTip="{lex:Loc Key={x:Static res:LocalizationKeys+Distribution.LevelSkillTooltip}}" />
                </StackPanel>
              </WrapPanel>
            </StackPanel>
          </Border>

          <!-- NPCs Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8"
                  Visibility="{Binding SelectedNpcs.Count, Converter={StaticResource CollectionCountToVisConverter}}">
            <StackPanel>
              <DockPanel Margin="0,0,0,6">
                <TextBlock Text="NPCs" FontWeight="SemiBold" FontSize="11" DockPanel.Dock="Left" />
              </DockPanel>
              <ItemsControl ItemsSource="{Binding SelectedNpcs}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,0,4,4" Padding="4,1" CornerRadius="2"
                            Background="{StaticResource Brush.PrimaryBackground}" BorderThickness="1">
                      <Border.Style>
                        <Style TargetType="Border">
                          <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding IsExcluded}" Value="True">
                              <Setter Property="BorderBrush" Value="{StaticResource Brush.Warning}" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal" Cursor="Hand"
                                    MouseLeftButtonDown="ToggleNpcNegation_Click" Tag="{Binding}"
                                    ToolTip="Click to toggle negation">
                          <TextBlock FontSize="11" VerticalAlignment="Center" Foreground="{StaticResource Brush.Warning}"
                                     Visibility="{Binding IsExcluded, Converter={StaticResource BoolToVisConverter}}">
                            -
                          </TextBlock>
                          <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                        </StackPanel>
                        <TextBlock Text="{Binding FormKeyString}"
                                   Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}"
                                   Margin="4,0,0,0" FontSize="9" />
                        <Button Click="RemoveNpc_Click" Tag="{Binding}"
                                Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                Margin="3,0,0,0" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Factions Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8"
                  Visibility="{Binding SelectedFactions.Count, Converter={StaticResource CollectionCountToVisConverter}}">
            <StackPanel>
              <DockPanel Margin="0,0,0,6">
                <TextBlock Text="Factions" FontWeight="SemiBold" FontSize="11" DockPanel.Dock="Left" />
                <ComboBox DockPanel.Dock="Right" MinWidth="70" Height="22" FontSize="11"
                          SelectedValue="{Binding FactionLogicMode, Mode=TwoWay}"
                          SelectedValuePath="Tag"
                          ToolTip="AND: All factions must match | OR: At least one faction must match">
                  <ComboBoxItem Content="AND" Tag="{x:Static models:FilterLogicMode.And}" />
                  <ComboBoxItem Content="OR" Tag="{x:Static models:FilterLogicMode.Or}" />
                </ComboBox>
              </DockPanel>
              <ItemsControl ItemsSource="{Binding SelectedFactions}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,0,4,4" Padding="4,1" CornerRadius="2"
                            Background="{StaticResource Brush.PrimaryBackground}" BorderThickness="1">
                      <Border.Style>
                        <Style TargetType="Border">
                          <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding IsExcluded}" Value="True">
                              <Setter Property="BorderBrush" Value="{StaticResource Brush.Warning}" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal" Cursor="Hand"
                                    MouseLeftButtonDown="ToggleFactionNegation_Click" Tag="{Binding}"
                                    ToolTip="Click to toggle negation">
                          <TextBlock FontSize="11" VerticalAlignment="Center" Foreground="{StaticResource Brush.Warning}"
                                     Visibility="{Binding IsExcluded, Converter={StaticResource BoolToVisConverter}}">
                            -
                          </TextBlock>
                          <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                        </StackPanel>
                        <TextBlock Text="{Binding FormKeyString}"
                                   Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}"
                                   Margin="4,0,0,0" FontSize="9" />
                        <Button Click="RemoveFaction_Click" Tag="{Binding}"
                                Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                Margin="3,0,0,0" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Keywords Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8"
                  Visibility="{Binding SelectedKeywords.Count, Converter={StaticResource CollectionCountToVisConverter}}">
            <StackPanel>
              <DockPanel Margin="0,0,0,6">
                <TextBlock Text="Keywords" FontWeight="SemiBold" FontSize="11" DockPanel.Dock="Left" />
                <ComboBox DockPanel.Dock="Right" MinWidth="70" Height="22" FontSize="11"
                          SelectedValue="{Binding KeywordLogicMode, Mode=TwoWay}"
                          SelectedValuePath="Tag"
                          ToolTip="AND: All keywords must match | OR: At least one keyword must match">
                  <ComboBoxItem Content="AND" Tag="{x:Static models:FilterLogicMode.And}" />
                  <ComboBoxItem Content="OR" Tag="{x:Static models:FilterLogicMode.Or}" />
                </ComboBox>
              </DockPanel>
              <ItemsControl ItemsSource="{Binding SelectedKeywords}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,0,4,4" Padding="4,1" CornerRadius="2"
                            Background="{StaticResource Brush.PrimaryBackground}" BorderThickness="1">
                      <Border.Style>
                        <Style TargetType="Border">
                          <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding IsExcluded}" Value="True">
                              <Setter Property="BorderBrush" Value="{StaticResource Brush.Warning}" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal" Cursor="Hand"
                                    MouseLeftButtonDown="ToggleKeywordNegation_Click" Tag="{Binding}"
                                    ToolTip="Click to toggle negation">
                          <TextBlock FontSize="11" VerticalAlignment="Center" Foreground="{StaticResource Brush.Warning}"
                                     Visibility="{Binding IsExcluded, Converter={StaticResource BoolToVisConverter}}">
                            -
                          </TextBlock>
                          <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                        </StackPanel>
                        <TextBlock Text="{Binding FormKeyString}"
                                   Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}"
                                   Margin="4,0,0,0" FontSize="9" />
                        <Button Click="RemoveKeyword_Click" Tag="{Binding}"
                                Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                Margin="3,0,0,0" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Races Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8"
                  Visibility="{Binding SelectedRaces.Count, Converter={StaticResource CollectionCountToVisConverter}}">
            <StackPanel>
              <DockPanel Margin="0,0,0,6">
                <TextBlock Text="Races" FontWeight="SemiBold" FontSize="11" DockPanel.Dock="Left" />
                <ComboBox DockPanel.Dock="Right" MinWidth="70" Height="22" FontSize="11"
                          SelectedValue="{Binding RaceLogicMode, Mode=TwoWay}"
                          SelectedValuePath="Tag"
                          ToolTip="AND: All races must match | OR: At least one race must match">
                  <ComboBoxItem Content="AND" Tag="{x:Static models:FilterLogicMode.And}" />
                  <ComboBoxItem Content="OR" Tag="{x:Static models:FilterLogicMode.Or}" />
                </ComboBox>
              </DockPanel>
              <ItemsControl ItemsSource="{Binding SelectedRaces}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,0,4,4" Padding="4,1" CornerRadius="2"
                            Background="{StaticResource Brush.PrimaryBackground}" BorderThickness="1">
                      <Border.Style>
                        <Style TargetType="Border">
                          <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding IsExcluded}" Value="True">
                              <Setter Property="BorderBrush" Value="{StaticResource Brush.Warning}" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <StackPanel Orientation="Horizontal">
                        <StackPanel Orientation="Horizontal" Cursor="Hand"
                                    MouseLeftButtonDown="ToggleRaceNegation_Click" Tag="{Binding}"
                                    ToolTip="Click to toggle negation">
                          <TextBlock FontSize="11" VerticalAlignment="Center" Foreground="{StaticResource Brush.Warning}"
                                     Visibility="{Binding IsExcluded, Converter={StaticResource BoolToVisConverter}}">
                            -
                          </TextBlock>
                          <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                        </StackPanel>
                        <TextBlock Text="{Binding FormKeyString}"
                                   Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}"
                                   Margin="4,0,0,0" FontSize="9" />
                        <Button Click="RemoveRace_Click" Tag="{Binding}"
                                Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                Margin="3,0,0,0" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Classes Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8"
                  Visibility="{Binding SelectedClasses.Count, Converter={StaticResource CollectionCountToVisConverter}}">
            <StackPanel>
              <DockPanel Margin="0,0,0,6">
                <TextBlock Text="Classes" FontWeight="SemiBold" FontSize="11" DockPanel.Dock="Left" />
                <ComboBox DockPanel.Dock="Right" MinWidth="70" Height="22" FontSize="11"
                          SelectedValue="{Binding ClassLogicMode, Mode=TwoWay}"
                          SelectedValuePath="Tag"
                          ToolTip="AND: All classes must match | OR: At least one class must match">
                  <ComboBoxItem Content="AND" Tag="{x:Static models:FilterLogicMode.And}" />
                  <ComboBoxItem Content="OR" Tag="{x:Static models:FilterLogicMode.Or}" />
                </ComboBox>
              </DockPanel>
              <ItemsControl ItemsSource="{Binding SelectedClasses}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,0,4,4" Padding="4,1" CornerRadius="2"
                            Background="{StaticResource Brush.PrimaryBackground}" BorderThickness="1"
                            BorderBrush="{StaticResource Brush.Border}">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding FormKeyString}"
                                   Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}"
                                   Margin="4,0,0,0" FontSize="9" />
                        <Button Click="RemoveClass_Click" Tag="{Binding}"
                                Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                Margin="3,0,0,0" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Locations Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8"
                  Visibility="{Binding SelectedLocations.Count, Converter={StaticResource CollectionCountToVisConverter}}">
            <StackPanel>
              <DockPanel Margin="0,0,0,6">
                <TextBlock Text="Locations" FontWeight="SemiBold" FontSize="11" DockPanel.Dock="Left" />
                <ComboBox DockPanel.Dock="Right" MinWidth="70" Height="22" FontSize="11"
                          SelectedValue="{Binding LocationLogicMode, Mode=TwoWay}"
                          SelectedValuePath="Tag"
                          ToolTip="AND: All locations must match | OR: At least one location must match">
                  <ComboBoxItem Content="AND" Tag="{x:Static models:FilterLogicMode.And}" />
                  <ComboBoxItem Content="OR" Tag="{x:Static models:FilterLogicMode.Or}" />
                </ComboBox>
              </DockPanel>
              <ItemsControl ItemsSource="{Binding SelectedLocations}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,0,4,4" Padding="4,1" CornerRadius="2"
                            Background="{StaticResource Brush.PrimaryBackground}" BorderThickness="1"
                            BorderBrush="{StaticResource Brush.Border}">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding FormKeyString}"
                                   Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}"
                                   Margin="4,0,0,0" FontSize="9" />
                        <Button Click="RemoveLocation_Click" Tag="{Binding}"
                                Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                Margin="3,0,0,0" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Outfit Filters Box -->
          <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                  Background="{StaticResource Brush.CardBackground}"
                  CornerRadius="4" Padding="8" Margin="0,0,0,8"
                  Visibility="{Binding SelectedOutfitFilters.Count, Converter={StaticResource CollectionCountToVisConverter}}">
            <StackPanel>
              <TextBlock Text="Outfit Filters" FontWeight="SemiBold" FontSize="11" Margin="0,0,0,6" />
              <ItemsControl ItemsSource="{Binding SelectedOutfitFilters}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Margin="0,0,4,4" Padding="4,1" CornerRadius="2"
                            Background="{StaticResource Brush.PrimaryBackground}" BorderThickness="1"
                            BorderBrush="{StaticResource Brush.Border}">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding EditorID}" FontSize="11" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding FormKeyString}"
                                   Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}"
                                   Margin="4,0,0,0" FontSize="9" />
                        <Button Click="RemoveOutfitFilter_Click" Tag="{Binding}"
                                Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                Margin="3,0,0,0" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Raw Filters -->
          <StackPanel Margin="0,0,0,8">
            <TextBlock Text="Raw Filters" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}"
                       Margin="0,0,0,4" />
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
              </Grid.RowDefinitions>
              <TextBlock Grid.Row="0" Grid.Column="0" Text="String:" VerticalAlignment="Center" Margin="0,0,6,4" />
              <TextBox Grid.Row="0" Grid.Column="1"
                       Text="{Binding RawStringFilters, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                       Height="26" FontFamily="Consolas" VerticalContentAlignment="Center" Margin="0,0,0,4"
                       ToolTip="Raw string filters: wildcards (*Mage), negations (-Exclude), and SPID-distributed keywords. Comma-separated for OR, plus-separated for AND." />
              <TextBlock Grid.Row="1" Grid.Column="0" Text="Form:" VerticalAlignment="Center" Margin="0,0,6,0" />
              <TextBox Grid.Row="1" Grid.Column="1"
                       Text="{Binding RawFormFilters, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                       Height="26" FontFamily="Consolas" VerticalContentAlignment="Center"
                       ToolTip="Raw form filters: negated factions (-FactionName), races, etc. Comma-separated for OR." />
            </Grid>
          </StackPanel>
        </StackPanel>
      </StackPanel>
    </ScrollViewer>
      </TabItem>

      <TabItem>
        <TabItem.Header>
          <StackPanel Orientation="Horizontal">
            <TextBlock Text="Results" />
            <TextBlock Text="{Binding MatchingNpcsCount, StringFormat=' ({0})'}" />
          </StackPanel>
        </TabItem.Header>
        <DockPanel Margin="6">
          <DockPanel.Style>
            <Style TargetType="DockPanel">
              <Setter Property="IsEnabled" Value="True" />
              <Style.Triggers>
                <DataTrigger Binding="{Binding SelectedEntry}" Value="{x:Null}">
                  <Setter Property="IsEnabled" Value="False" />
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </DockPanel.Style>

          <TextBlock DockPanel.Dock="Bottom"
                     Text="{Binding MatchingNpcsCount, StringFormat='Total: {0} NPCs'}"
                     Margin="0,6,0,0" FontSize="11"
                     Foreground="{StaticResource Brush.TextSecondary}" />

          <DataGrid ItemsSource="{Binding MatchingNpcsForSelectedEntry}"
                    AutoGenerateColumns="False" IsReadOnly="True"
                    HeadersVisibility="Column" GridLinesVisibility="None"
                    SelectionMode="Single" CanUserReorderColumns="False"
                    CanUserResizeRows="False" CanUserSortColumns="True"
                    BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                    Background="{StaticResource Brush.PrimaryBackground}"
                    RowBackground="{StaticResource Brush.CardBackground}"
                    AlternatingRowBackground="{StaticResource Brush.PrimaryBackground}">
            <DataGrid.Columns>
              <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="2*" />
              <DataGridTextColumn Header="Criteria" Binding="{Binding Criteria}" Width="2*">
                <DataGridTextColumn.ElementStyle>
                  <Style TargetType="TextBlock">
                    <Setter Property="Foreground" Value="{StaticResource Brush.TextSecondary}" />
                    <Setter Property="FontSize" Value="11" />
                  </Style>
                </DataGridTextColumn.ElementStyle>
              </DataGridTextColumn>
              <DataGridTextColumn Header="EditorID" Binding="{Binding EditorId}" Width="1.5*">
                <DataGridTextColumn.ElementStyle>
                  <Style TargetType="TextBlock">
                    <Setter Property="Foreground" Value="{StaticResource Brush.TextSecondary}" />
                    <Setter Property="FontSize" Value="11" />
                  </Style>
                </DataGridTextColumn.ElementStyle>
              </DataGridTextColumn>
              <DataGridTextColumn Header="FormKey" Binding="{Binding FormKey}" Width="1.5*">
                <DataGridTextColumn.ElementStyle>
                  <Style TargetType="TextBlock"
                         BasedOn="{StaticResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}" />
                </DataGridTextColumn.ElementStyle>
              </DataGridTextColumn>
            </DataGrid.Columns>
          </DataGrid>
        </DockPanel>
      </TabItem>
    </TabControl>
  </GroupBox>
</UserControl>
